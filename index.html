<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>√áarrakverse: Pixel Boss Rush</title>
<style>
  body { margin:0; background:#000; overflow:hidden; font-family:Arial; }
  canvas {
    display:block; margin:0 auto;
    background:#0b0b0b;
    image-rendering: pixelated;
  }
  .hud {
    position:absolute;
    top:0; left:0;
    width:100%;
    padding:10px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    color:#fff;
    text-shadow:0 0 6px #000;
    pointer-events:none;
    font-family: monospace;
  }
  .panel {
    background: rgba(0,0,0,0.5);
    border:1px solid rgba(255,255,255,0.12);
    padding:10px;
    border-radius:12px;
    min-width:320px;
  }
  .bar {
    width: 280px;
    height: 14px;
    border:1px solid rgba(255,255,255,0.4);
    background:#111;
    margin-top:4px;
    position:relative;
    border-radius:4px;
    overflow:hidden;
  }
  .fill {
    height:100%;
    width:100%;
    background: linear-gradient(90deg, #00ff88, #ffcc00, #ff0033);
  }
  .ultifill {
    height:100%;
    width:0%;
    background: linear-gradient(90deg, #00ccff, #cc00ff, #ff00aa);
  }

  .center {
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    color:#fff;
    font-size:22px;
    text-align:center;
    text-shadow:0 0 12px #000;
    width:80%;
  }

  .btnRow {
    margin-top:16px;
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    pointer-events:auto;
  }
  button {
    background:#111;
    color:#fff;
    border:1px solid rgba(255,255,255,0.2);
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
  }
  button:hover {
    background:#1d1d1d;
  }

  .tiny {
    font-size:14px;
    opacity:0.85;
  }
</style>
</head>
<body>

<div class="hud">
  <div class="panel">
    <b>OYUNCU: √áARRAK</b><br>
    HP
    <div class="bar"><div id="pHP" class="fill"></div></div>
    ULTI
    <div class="bar"><div id="pULTI" class="ultifill"></div></div>
    <div class="tiny" id="pInfo">Combo: 0 | Skor: 0</div>
  </div>

  <div class="panel" style="text-align:right;">
    <b id="bossName">BOSS: ???</b><br>
    HP
    <div class="bar"><div id="bHP" class="fill"></div></div>
    <div class="tiny" id="bInfo">Phase: 1</div>
  </div>
</div>

<div class="center" id="overlay"></div>

<canvas id="game" width="960" height="540"></canvas>

<script>
/* ===========================
   √áARRAKVERSE: PIXEL BOSS GAME
   Tek dosya, canvas fighter
=========================== */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
ctx.imageSmoothingEnabled = false;

const overlay = document.getElementById("overlay");
const pHPBar = document.getElementById("pHP");
const bHPBar = document.getElementById("bHP");
const pULTIBar = document.getElementById("pULTI");
const pInfo = document.getElementById("pInfo");
const bInfo = document.getElementById("bInfo");
const bossNameEl = document.getElementById("bossName");

const keys = {};
window.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
window.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function rand(min,max){ return min + Math.random()*(max-min); }

function rect(x,y,w,h,c){
  ctx.fillStyle = c;
  ctx.fillRect(x,y,w,h);
}

function text(txt,x,y,size=14,color="#fff"){
  ctx.fillStyle = color;
  ctx.font = size + "px monospace";
  ctx.fillText(txt,x,y);
}

function speak(line){
  try{
    const u = new SpeechSynthesisUtterance(line);
    u.lang = "tr-TR";
    u.rate = 1.05;
    u.pitch = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}

let shake = 0;
function screenShake(power=6){
  shake = Math.max(shake, power);
}

let particles = [];
function spark(x,y, colorA="#ffcc00", colorB="#ff0033"){
  for(let i=0;i<10;i++){
    particles.push({
      x,y,
      vx: rand(-2.8,2.8),
      vy: rand(-3.5,-0.5),
      life: rand(12,22),
      c: Math.random()<0.5 ? colorA : colorB
    });
  }
}

function drawParticles(){
  particles.forEach(p=>{
    ctx.globalAlpha = clamp(p.life/22, 0, 1);
    rect(p.x, p.y, 4, 4, p.c);
    ctx.globalAlpha = 1;
  });
}

function updateParticles(){
  particles.forEach(p=>{
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.25;
    p.life -= 1;
  });
  particles = particles.filter(p=>p.life>0);
}

const gravity = 0.75;
const groundY = 420;

const player = {
  name:"√áarrak",
  x: 220,
  y: groundY,
  vx: 0,
  vy: 0,
  w: 40,
  h: 62,
  hp: 120,
  maxHp: 120,
  ulti: 0,
  maxUlti: 100,
  facing: 1,
  state: "idle",
  animT: 0,
  hitstun: 0,
  atkCD: 0,
  dashCD: 0,
  block: false,
  combo: 0,
  score: 0,
  invuln: 0
};

let boss = null;

const BOSSES = [
  {
    id:"sivas_kangali",
    name:"Sƒ∞VAS KANGALI",
    maxHp: 140,
    colorBody:"#c49a6c",
    colorHead:"#ffddaa",
    voiceLines:[
      "Hav hav deƒüil... bu bir manifesto.",
      "√áarrak... kemiklerin iptal.",
      "Sivas'tan selam getirdim!"
    ],
    ai: "hound",
    intro: "B√∂l√ºm 1: Sƒ∞VAS KANGALI\n\nKangal arenaya girdi.\nAurasƒ±: '√ßoban wifi'si'."
  },
  {
    id:"muhalefet",
    name:"MUHALEFET",
    maxHp: 160,
    colorBody:"#00ccff",
    colorHead:"#ffffff",
    voiceLines:[
      "Biz geliyoruz ama biraz yava≈ü...",
      "Plan var ama kimde olduƒüunu bilmiyoruz.",
      "√áarrak... seni g√ºndeme alacaƒüƒ±z."
    ],
    ai: "debate",
    intro: "B√∂l√ºm 2: MUHALEFET\n\nS√∂zl√º saldƒ±rƒ± uzmanƒ±.\nSilahƒ±: 'G√ºndem Deƒüi≈ütirme'."
  },
  {
    id:"eleren",
    name:"ELEREN",
    maxHp: 180,
    colorBody:"#cc00ff",
    colorHead:"#ffcc00",
    voiceLines:[
      "Ben Eleren. Benimle tartƒ±≈üma.",
      "Chat beni seviyor, sen kimsin?",
      "√áarrak... sana cringe basacaƒüƒ±m."
    ],
    ai: "trickster",
    intro: "B√∂l√ºm 3: ELEREN\n\nArena ƒ±≈üƒ±klarƒ± karardƒ±.\nEleren glitch a√ßtƒ±."
  },
  {
    id:"kokusukviyuyuyuy",
    name:"KOKU≈ûUKVƒ∞YUYUYUY",
    maxHp: 210,
    colorBody:"#55ff55",
    colorHead:"#bbbbbb",
    voiceLines:[
      "Benim adƒ±m bile bug.",
      "Koku≈üuk... ve gururluyum.",
      "√áarrak, senin FPS'in d√º≈üecek."
    ],
    ai: "toxic",
    intro: "B√∂l√ºm 4: KOKU≈ûUKVƒ∞YUYUYUY\n\nHavada 'lag kokusu' var.\nBu boss bir hata gibi."
  },
  {
    id:"ergunus_maximus",
    name:"ERG√úNUS MAXIMUS",
    maxHp: 260,
    colorBody:"#ff0033",
    colorHead:"#bbbbbb",
    voiceLines:[
      "Ben son bossum. Beni yenemezsin.",
      "√áarrak... senin kaderin patlak.",
      "Benim egom bile boss fight."
    ],
    ai: "final",
    intro: "B√∂l√ºm 5: ERG√úNUS MAXIMUS\n\nFinal kapƒ±sƒ± a√ßƒ±ldƒ±.\nG√∂ky√ºz√º patladƒ±."
  }
];

function createBoss(index){
  const b = BOSSES[index];
  return {
    index,
    id: b.id,
    name: b.name,
    x: 700,
    y: groundY,
    vx: 0,
    vy: 0,
    w: 46,
    h: 70,
    hp: b.maxHp,
    maxHp: b.maxHp,
    phase: 1,
    rage: 0,
    hitstun: 0,
    atkCD: 0,
    specialCD: 0,
    facing: -1,
    state: "idle",
    animT: 0,
    colorBody: b.colorBody,
    colorHead: b.colorHead,
    ai: b.ai,
    voiceLines: b.voiceLines,
    intro: b.intro
  };
}

function playerBox(){
  return {x:player.x, y:player.y, w:player.w, h:player.h};
}
function bossBox(){
  return {x:boss.x, y:boss.y, w:boss.w, h:boss.h};
}
function overlaps(a,b){
  return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

function attackBox(entity, type){
  let range = 40;
  let height = 24;
  let offsetY = 20;

  if(type==="kick"){ range = 55; height = 28; }
  if(type==="upper"){ range = 38; height = 38; offsetY = 5; }
  if(type==="ulti"){ range = 120; height = 60; offsetY = 0; }

  let ax = entity.facing === 1 ? entity.x + entity.w : entity.x - range;
  let ay = entity.y + offsetY;
  return {x:ax, y:ay, w:range, h:height};
}

function takeDamage(target, dmg, knockX, isBoss=false){
  if(target.invuln && target.invuln>0) return;

  if(target === player && player.block){
    dmg = Math.floor(dmg * 0.35);
    spark(player.x+player.w/2, player.y+20, "#00ccff", "#ffffff");
  }

  target.hp -= dmg;
  if(target.hp < 0) target.hp = 0;

  if(target === player){
    player.hitstun = 10;
    player.vx += knockX;
    player.combo = 0;
    screenShake(6);
  } else {
    boss.hitstun = 10;
    boss.vx += knockX;
    player.combo += 1;
    player.score += dmg * (1 + player.combo*0.08);
    player.ulti = clamp(player.ulti + dmg*0.6, 0, player.maxUlti);
    screenShake(7);
  }
}

function drawFighter(x,y,w,h, body, head, facing, state, animT, label){
  // shadow
  rect(x-6, y+h, w+12, 6, "rgba(0,0,0,0.55)");

  // slight animation bounce
  let bounce = Math.sin(animT*0.2) * 2;

  // legs (walk animation)
  let legOffset = (state==="walk") ? Math.sin(animT*0.3)*4 : 0;
  rect(x+6, y+44 + bounce + legOffset, 10, 18, body);
  rect(x+24, y+44 + bounce - legOffset, 10, 18, body);

  // torso
  rect(x+6, y+18 + bounce, 28, 28, body);

  // head
  rect(x+10, y+2 + bounce, 20, 18, head);

  // eyes
  rect(x + (facing===1?20:14), y+8 + bounce, 3, 3, "#000");
  rect(x + (facing===1?26:20), y+8 + bounce, 3, 3, "#000");

  // mouth (changes on hit)
  if(state==="hurt"){
    rect(x+16, y+15 + bounce, 10, 2, "#ff0033");
  } else {
    rect(x+16, y+14 + bounce, 10, 2, "#000");
  }

  // arm animation
  let armLen = 14;
  if(state==="punch") armLen = 26;
  if(state==="kick") armLen = 22;
  if(state==="upper") armLen = 20;
  if(state==="ulti") armLen = 40;
  if(state==="block") armLen = 10;

  if(facing===1){
    rect(x+32, y+22 + bounce, armLen, 8, "#fff");
  } else {
    rect(x-armLen, y+22 + bounce, armLen, 8, "#fff");
  }

  // aura for ulti
  if(state==="ulti"){
    ctx.globalAlpha = 0.18;
    rect(x-14, y-14, w+28, h+28, "#cc00ff");
    rect(x-20, y-20, w+40, h+40, "#00ccff");
    ctx.globalAlpha = 1;
  }

  // label
  text(label, x-10, y-10, 12, "rgba(255,255,255,0.75)");
}

function bossAI(){
  if(!boss) return;

  boss.animT++;

  if(boss.hp <= boss.maxHp*0.55 && boss.phase === 1){
    boss.phase = 2;
    speak(boss.name + " ikinci forma ge√ßti!");
    screenShake(12);
    spark(boss.x+20, boss.y+20, "#ff0033", "#ffffff");
    boss.specialCD = 50;
  }

  boss.hitstun = Math.max(0, boss.hitstun-1);
  boss.atkCD = Math.max(0, boss.atkCD-1);
  boss.specialCD = Math.max(0, boss.specialCD-1);

  if(boss.hitstun > 0){
    boss.vx *= 0.82;
    boss.state = "hurt";
    return;
  }

  let dist = player.x - boss.x;
  let abs = Math.abs(dist);
  boss.facing = dist>0 ? 1 : -1;

  let baseSpeed = 2.2 + boss.phase*0.8;

  // Different boss behaviors
  if(boss.ai === "hound"){
    // rush & bite
    if(abs > 120){
      boss.vx = boss.facing * (baseSpeed+1.2);
      boss.state = "walk";
    } else {
      boss.vx *= 0.8;
      if(boss.atkCD <= 0){
        boss.state = "kick";
        boss.atkCD = 35;
      }
      if(boss.phase===2 && boss.specialCD<=0 && Math.random()<0.3){
        boss.state="ulti";
        boss.specialCD = 90;
        boss.atkCD = 55;
        screenShake(10);
        speak("HAV HAV KOMBO!");
        // AoE bite
        if(abs < 160){
          takeDamage(player, 18, boss.facing*8);
          spark(player.x+player.w/2, player.y+20, "#c49a6c", "#ff0033");
        }
      }
    }
  }

  if(boss.ai === "debate"){
    // stays mid-range and throws "argument"
    if(abs < 140){
      boss.vx = -boss.facing * baseSpeed;
      boss.state="walk";
    } else if(abs > 260){
      boss.vx = boss.facing * baseSpeed;
      boss.state="walk";
    } else {
      boss.vx *= 0.85;
      boss.state="idle";
      if(boss.atkCD<=0){
        boss.atkCD = 45 - boss.phase*8;
        // argument projectile (fake)
        projectiles.push({
          x: boss.x + boss.w/2,
          y: boss.y + 25,
          vx: boss.facing * (5.5 + boss.phase*1.2),
          w: 14,
          h: 10,
          dmg: 10 + boss.phase*3,
          color:"#00ccff",
          type:"argument"
        });
        speak("G√úNDEM!");
      }
    }
  }

  if(boss.ai === "trickster"){
    // teleport-ish dash
    if(boss.phase===2 && boss.specialCD<=0 && Math.random()<0.02){
      boss.specialCD = 90;
      boss.x = clamp(player.x + rand(-220,220), 60, canvas.width-100);
      screenShake(8);
      spark(boss.x+20, boss.y+20, "#cc00ff", "#ffcc00");
      speak("GLITCH ATTIM.");
    }

    if(abs > 110){
      boss.vx = boss.facing * (baseSpeed+0.7);
      boss.state="walk";
    } else {
      boss.vx *= 0.7;
      if(boss.atkCD<=0){
        boss.atkCD = 35 - boss.phase*6;
        boss.state = Math.random()<0.5 ? "punch" : "upper";
      }
    }
  }

  if(boss.ai === "toxic"){
    // poison cloud + slow hits
    if(boss.phase===2 && boss.specialCD<=0 && Math.random()<0.03){
      boss.specialCD = 100;
      speak("KOKU SALDIM!");
      poisonClouds.push({
        x: boss.x + boss.facing*70,
        y: boss.y + 25,
        r: 10,
        life: 180
      });
      screenShake(8);
    }

    if(abs > 150){
      boss.vx = boss.facing * (baseSpeed);
      boss.state="walk";
    } else {
      boss.vx *= 0.85;
      if(boss.atkCD<=0){
        boss.atkCD = 40 - boss.phase*5;
        boss.state="kick";
      }
    }
  }

  if(boss.ai === "final"){
    // very aggressive with random specials
    if(abs > 90){
      boss.vx = boss.facing * (baseSpeed+1.2);
      boss.state="walk";
    } else {
      boss.vx *= 0.65;
      if(boss.atkCD<=0){
        boss.atkCD = 30 - boss.phase*5;
        let roll = Math.random();
        if(roll < 0.4) boss.state="punch";
        else if(roll < 0.75) boss.state="kick";
        else boss.state="upper";
      }

      if(boss.phase===2 && boss.specialCD<=0 && Math.random()<0.06){
        boss.specialCD = 100;
        boss.state="ulti";
        speak("PATLAK METEOR!");
        screenShake(14);

        // meteor rain
        for(let i=0;i<6;i++){
          projectiles.push({
            x: player.x + rand(-250,250),
            y: -50 - i*30,
            vx: rand(-1.2,1.2),
            vy: rand(5.5,7.5),
            w: 14,
            h: 14,
            dmg: 14,
            color:"#ff0033",
            type:"meteor"
          });
        }
      }
    }
  }

  // boss attack execution timing
  if(boss.state==="punch" && boss.atkCD === 20){
    if(overlaps(attackBox(boss,"punch"), playerBox())){
      takeDamage(player, 12 + boss.phase*2, boss.facing*7);
      spark(player.x+player.w/2, player.y+20);
    }
  }

  if(boss.state==="kick" && boss.atkCD === 25){
    if(overlaps(attackBox(boss,"kick"), playerBox())){
      takeDamage(player, 16 + boss.phase*2, boss.facing*9);
      spark(player.x+player.w/2, player.y+20);
    }
  }

  if(boss.state==="upper" && boss.atkCD === 20){
    if(overlaps(attackBox(boss,"upper"), playerBox())){
      takeDamage(player, 18 + boss.phase*3, boss.facing*11);
      player.vy = -10;
      spark(player.x+player.w/2, player.y+10, "#ffcc00", "#cc00ff");
    }
  }

  // physics
  boss.vy += gravity;
  boss.x += boss.vx;
  boss.y += boss.vy;

  if(boss.y > groundY){
    boss.y = groundY;
    boss.vy = 0;
  }

  boss.x = clamp(boss.x, 40, canvas.width-80);
}

let projectiles = [];
let poisonClouds = [];

function updateProjectiles(){
  projectiles.forEach(p=>{
    p.x += p.vx;
    if(p.vy) p.y += p.vy;

    // player hit
    const pb = playerBox();
    const pr = {x:p.x, y:p.y, w:p.w, h:p.h};
    if(overlaps(pb, pr)){
      takeDamage(player, p.dmg, (p.vx||0)*1.5);
      spark(player.x+player.w/2, player.y+20, p.color, "#fff");
      p.dead = true;
    }

    if(p.x < -100 || p.x > canvas.width+100 || p.y > canvas.height+200){
      p.dead = true;
    }
  });

  projectiles = projectiles.filter(p=>!p.dead);
}

function drawProjectiles(){
  projectiles.forEach(p=>{
    rect(p.x, p.y, p.w, p.h, p.color);
    ctx.globalAlpha = 0.2;
    rect(p.x-4, p.y-4, p.w+8, p.h+8, p.color);
    ctx.globalAlpha = 1;
  });
}

function updatePoison(){
  poisonClouds.forEach(c=>{
    c.life--;
    c.r = 25 + Math.sin(c.life*0.08)*6;

    // damage over time if inside
    let px = player.x + player.w/2;
    let py = player.y + 30;
    let dx = px - c.x;
    let dy = py - c.y;
    let dist = Math.sqrt(dx*dx+dy*dy);

    if(dist < c.r){
      if(frameCount % 20 === 0){
        takeDamage(player, 4, 0);
        spark(player.x+player.w/2, player.y+20, "#55ff55", "#bbbbbb");
      }
    }
  });

  poisonClouds = poisonClouds.filter(c=>c.life>0);
}

function drawPoison(){
  poisonClouds.forEach(c=>{
    ctx.globalAlpha = 0.15;
    rect(c.x-c.r, c.y-c.r, c.r*2, c.r*2, "#55ff55");
    ctx.globalAlpha = 1;
  });
}

function playerControls(){
  player.animT++;
  player.hitstun = Math.max(0, player.hitstun-1);
  player.atkCD = Math.max(0, player.atkCD-1);
  player.dashCD = Math.max(0, player.dashCD-1);
  player.invuln = Math.max(0, player.invuln-1);

  player.block = keys["shift"];

  if(player.hitstun > 0){
    player.state = "hurt";
  } else {
    let speed = 3.4;

    if(keys["a"]){
      player.vx = -speed;
      player.facing = -1;
      player.state = "walk";
    } else if(keys["d"]){
      player.vx = speed;
      player.facing = 1;
      player.state = "walk";
    } else {
      player.vx *= 0.75;
      if(player.atkCD <= 0) player.state = player.block ? "block" : "idle";
    }

    if(keys["w"] && player.y >= groundY){
      player.vy = -12.5;
      player.state = "jump";
    }

    // dash
    if(keys[" "] && player.dashCD <= 0){
      player.state = "dash";
      player.vx = player.facing * 13;
      player.invuln = 10;
      player.dashCD = 55;
      screenShake(4);
      spark(player.x+player.w/2, player.y+40, "#00ccff", "#fff");
    }

    // attacks
    if(keys["j"] && player.atkCD <= 0){
      player.state = "punch";
      player.atkCD = 16;
      if(overlaps(attackBox(player,"punch"), bossBox())){
        takeDamage(boss, 11, player.facing*8, true);
        spark(boss.x+boss.w/2, boss.y+20);
      }
    }

    if(keys["k"] && player.atkCD <= 0){
      player.state = "kick";
      player.atkCD = 24;
      if(overlaps(attackBox(player,"kick"), bossBox())){
        takeDamage(boss, 15, player.facing*11, true);
        spark(boss.x+boss.w/2, boss.y+20);
      }
    }

    if(keys["l"] && player.ulti >= 100 && player.atkCD <= 0){
      player.state = "ulti";
      player.atkCD = 55;
      player.ulti = 0;
      speak("√áARRAK ULTI!");
      screenShake(16);

      if(overlaps(attackBox(player,"ulti"), bossBox())){
        takeDamage(boss, 42, player.facing*18, true);
        spark(boss.x+boss.w/2, boss.y+10, "#00ccff", "#cc00ff");
      }
    }
  }

  // physics
  player.vy += gravity;
  player.x += player.vx;
  player.y += player.vy;

  if(player.y > groundY){
    player.y = groundY;
    player.vy = 0;
  }

  player.x = clamp(player.x, 40, canvas.width-80);
}

function drawBackground(){
  rect(0,0,canvas.width,canvas.height,"#070707");

  // city blocks
  for(let i=0;i<40;i++){
    let bx = i*30;
    let h = 40 + (i%8)*18;
    rect(bx, 290-h, 26, h, "rgba(255,255,255,0.05)");
  }

  // floor
  rect(0, groundY+60, canvas.width, canvas.height, "#030303");
  rect(0, groundY+55, canvas.width, 10, "#1f1f1f");

  // neon strips
  for(let i=0;i<22;i++){
    rect(i*50, groundY+58, 20, 2, "rgba(255,0,51,0.25)");
  }

  text("√áARRAKVERSE - PIXEL BOSS RUSH", 20, 30, 18, "#ffcc00");
}

function updateHUD(){
  pHPBar.style.width = (player.hp/player.maxHp*100) + "%";
  bHPBar.style.width = (boss.hp/boss.maxHp*100) + "%";
  pULTIBar.style.width = (player.ulti/player.maxUlti*100) + "%";

  pInfo.textContent = `Combo: ${player.combo} | Skor: ${Math.floor(player.score)}`;
  bInfo.textContent = `Phase: ${boss.phase}`;
  bossNameEl.textContent = "BOSS: " + boss.name;
}

function draw(){
  let sx=0, sy=0;
  if(shake>0){
    sx = rand(-shake,shake);
    sy = rand(-shake,shake);
    shake *= 0.85;
    if(shake < 0.5) shake = 0;
  }

  ctx.save();
  ctx.translate(sx, sy);

  drawBackground();

  drawPoison();
  drawProjectiles();

  // fighters
  drawFighter(player.x, player.y, player.w, player.h,
    "#00ccff", "#ffcc00",
    player.facing,
    player.state,
    player.animT,
    "√áARRAK"
  );

  drawFighter(boss.x, boss.y, boss.w, boss.h,
    boss.colorBody, boss.colorHead,
    boss.facing,
    boss.state,
    boss.animT,
    boss.name
  );

  drawParticles();
  ctx.restore();
}

let frameCount = 0;
let levelIndex = 0;
let playing = false;
let startTime = 0;

function showMenu(){
  overlay.style.display = "block";
  overlay.innerHTML = `
    <div style="font-size:34px; font-weight:bold;">√áARRAKVERSE</div>
    <div class="tiny">Pixel Boss Rush | Kara mizah abs√ºrt evren</div>
    <br>
    <div class="tiny">
      Kontroller:<br>
      <b>A/D</b> y√ºr√º - <b>W</b> zƒ±pla - <b>J</b> yumruk - <b>K</b> tekme<br>
      <b>Shift</b> block - <b>Space</b> dash - <b>L</b> ulti
    </div>
    <div class="btnRow">
      <button onclick="startStory()">Hikaye Modu</button>
      <button onclick="startBossRush()">Boss Rush</button>
      <button onclick="showLeaderboard()">Leaderboard</button>
    </div>
    <div class="tiny" style="margin-top:14px; opacity:0.7;">
      Not: Bu evren tamamen hayal √ºr√ºn√ºd√ºr. Her ≈üey abs√ºrt parodidir.
    </div>
  `;
}

function showLeaderboard(){
  const data = JSON.parse(localStorage.getItem("carrak_leaderboard") || "[]");
  let html = `<div style="font-size:28px;font-weight:bold;">üèÜ Patlaklƒ±k Leaderboard</div><br>`;

  if(data.length === 0){
    html += `<div class="tiny">Hen√ºz kimse destan yazmamƒ±≈ü...</div>`;
  } else {
    html += `<div style="font-size:14px;text-align:left;display:inline-block;">`;
    data.slice(0,10).forEach((x,i)=>{
      html += `${i+1}. <b>${x.name}</b> | Skor: ${x.score} | S√ºre: ${x.time}s<br>`;
    });
    html += `</div>`;
  }

  html += `
    <div class="btnRow">
      <button onclick="showMenu()">Geri</button>
      <button onclick="resetLeaderboard()">Sƒ±fƒ±rla</button>
    </div>
  `;

  overlay.style.display="block";
  overlay.innerHTML = html;
}

function resetLeaderboard(){
  localStorage.removeItem("carrak_leaderboard");
  showLeaderboard();
}

function introLevel(){
  playing = false;
  boss = createBoss(levelIndex);

  overlay.style.display="block";
  overlay.innerHTML = `
    <div style="font-size:26px;font-weight:bold;">${boss.name}</div>
    <div class="tiny" style="white-space:pre-line; margin-top:10px;">
${boss.intro}
    </div>
    <div class="btnRow">
      <button onclick="beginFight()">D√∂v√º≈ü Ba≈ülat</button>
      <button onclick="showMenu()">Men√º</button>
    </div>
  `;

  // boss talks
  setTimeout(()=>{
    speak(boss.voiceLines[Math.floor(Math.random()*boss.voiceLines.length)]);
  }, 500);
}

function beginFight(){
  overlay.style.display="none";
  playing = true;

  // reset player partially
  player.x = 220;
  player.y = groundY;
  player.vx = 0;
  player.vy = 0;
  player.combo = 0;
  player.hitstun = 0;

  boss.x = 700;
  boss.y = groundY;
  boss.vx = 0;
  boss.vy = 0;

  projectiles = [];
  poisonClouds = [];
}

function startStory(){
  levelIndex = 0;
  player.hp = player.maxHp;
  player.ulti = 0;
  player.score = 0;
  startTime = Date.now();
  introLevel();
}

function startBossRush(){
  levelIndex = 0;
  player.hp = player.maxHp;
  player.ulti = 0;
  player.score = 0;
  startTime = Date.now();
  introLevel();
}

function winBoss(){
  playing = false;
  levelIndex++;

  if(levelIndex >= BOSSES.length){
    const endTime = Math.floor((Date.now() - startTime)/1000);

    overlay.style.display="block";
    overlay.innerHTML = `
      <div style="font-size:32px;font-weight:bold;">üèÜ √áARRAKVERSE TAMAMLANDI</div>
      <div class="tiny" style="margin-top:10px;">
        Skor: <b>${Math.floor(player.score)}</b><br>
        S√ºre: <b>${endTime}s</b><br><br>
        Finalde patlaklƒ±k √ß√∂kt√º.<br>
        √áarrak tarihe ge√ßti.
      </div>
      <div class="btnRow">
        <button onclick="saveScore(${endTime})">Skoru Kaydet</button>
        <button onclick="showMenu()">Men√º</button>
      </div>
    `;
    speak("Zafer. √áarrakverse artƒ±k senin.");
    return;
  }

  overlay.style.display="block";
  overlay.innerHTML = `
    <div style="font-size:28px;font-weight:bold;">‚úÖ Boss d√º≈üt√º!</div>
    <div class="tiny">Yeni b√∂l√ºm a√ßƒ±ldƒ±...</div>
    <div class="btnRow">
      <button onclick="introLevel()">Devam Et</button>
      <button onclick="showMenu()">Men√º</button>
    </div>
  `;

  speak("Devam et. Patlaklƒ±k daha bitmedi.");
}

function saveScore(timeSec){
  let name = prompt("Leaderboard ismin ne olsun? (√∂rn: Kral√áarrak)");
  if(!name) name = "Anon√áarrak";

  let data = JSON.parse(localStorage.getItem("carrak_leaderboard") || "[]");
  data.push({
    name,
    score: Math.floor(player.score),
    time: timeSec
  });

  data.sort((a,b)=>{
    // score desc, time asc
    if(b.score !== a.score) return b.score - a.score;
    return a.time - b.time;
  });

  localStorage.setItem("carrak_leaderboard", JSON.stringify(data));
  showLeaderboard();
}

function loseGame(){
  playing = false;
  overlay.style.display="block";
  overlay.innerHTML = `
    <div style="font-size:32px;font-weight:bold;">üíÄ √áARRAK D√ú≈ûT√ú</div>
    <div class="tiny" style="margin-top:10px;">
      Boss: <b>${boss.name}</b><br>
      Skor: <b>${Math.floor(player.score)}</b><br><br>
      √áarrak yere d√º≈üt√º ama cringe asla √∂lmez...
    </div>
    <div class="btnRow">
      <button onclick="introLevel()">Tekrar Dene</button>
      <button onclick="showMenu()">Men√º</button>
    </div>
  `;
  speak("√áarrak... yenildin.");
}

function update(){
  frameCount++;

  if(!boss){
    return;
  }

  if(!playing){
    updateHUD();
    return;
  }

  playerControls();
  bossAI();

  updateProjectiles();
  updatePoison();
  updateParticles();

  // boss voice random taunt
  if(frameCount % 360 === 0 && Math.random() < 0.35){
    speak(boss.voiceLines[Math.floor(Math.random()*boss.voiceLines.length)]);
  }

  // passive ulti regen
  if(frameCount % 40 === 0){
    player.ulti = clamp(player.ulti + 2, 0, player.maxUlti);
  }

  // win/lose checks
  if(player.hp <= 0){
    loseGame();
  }

  if(boss.hp <= 0){
    winBoss();
  }

  updateHUD();
}

function loop(){
  draw();
  update();
  requestAnimationFrame(loop);
}

showMenu();
loop();
</script>

</body>
</html>
